<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark">
<meta property="og:title" content="Airflow on Vineyard" />
  
<meta property="og:type" content="website" />
  
<meta property="og:url" content="notes/airflow.html" />
  
<meta property="og:description" content="Big data analytical pipelines usually involves various kinds of workloads, each of them requires a dedicated compute system to finish the job, and intermediate data flows between tasks in the pipel..." />
  <link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Deployment" href="../deployment.html" /><link rel="prev" title="Machine Learning with Vineyard" href="ml.html" />

    <link rel="shortcut icon" href="../_static/vineyard.ico"/><meta name="generator" content="sphinx-5.0.2, furo 2022.06.21"/>
        <title>Airflow on Vineyard - Vineyard</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=40978830699223671f4072448e654b5958f38b89" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    <link rel="stylesheet" type="text/css" href="../_static/css/brands.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/v4-shims.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/panels.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
  <script>
    document.body.dataset.theme = "light";
  </script>


<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">Vineyard</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand centered" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/vineyard-logo-h.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../user-guide.html">User Guide</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="objects.html">Internals of Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="data-accessing.html">Shared Data Accessing</a></li>
<li class="toctree-l2"><a class="reference internal" href="streams.html">Streams in Vineyard</a></li>
<li class="toctree-l2"><a class="reference internal" href="io-drivers.html">I/O Drivers</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/distributed-learning.html">Distributed Learning with Vineyard</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorials/adding-custom-datatypes-cpp.html">Adding Custom Data Types in C++</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Integrations</span></p>
<ul class="current">
<li class="toctree-l1 current has-children"><a class="reference internal" href="../integrations.html">Integrations</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="dask.html">Dask on Vineyard</a></li>
<li class="toctree-l2"><a class="reference internal" href="ml.html">Machine Learning with Vineyard</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Airflow on Vineyard</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../deployment.html">Deployment</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="deploy-locally.html">Deploying on Linux/MacOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy-docker.html">Deploying using Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="deploy-kubernetes.html">Deploying on Kubernetes</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api-reference.html">API Reference</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="python-api.html">Python API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpp-api.html">C++ API Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="ctl.html">Vineyard Cli</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../community.html">Join the Community</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="contributing.html">Contributing to vineyard</a></li>
<li class="toctree-l2"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l2"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/v6d-io/v6d/edit/main/docs/notes/airflow.rst" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="section" id="airflow-on-vineyard">
<h1>Airflow on Vineyard<a class="headerlink" href="#airflow-on-vineyard" title="Permalink to this heading">#</a></h1>
<p>Big data analytical pipelines usually involves various kinds of workloads, each
of them requires a dedicated compute system to finish the job, and intermediate
data flows between tasks in the pipeline. The extra cost of transferring data
takes a non-negligible portion in the end-to-end performance in real world deployment
and the optimization is challenging.</p>
<p>Integrating Vineyard with Airflow brings opportunities to mitigate the problem.</p>
<div class="section" id="introducing-airflow">
<h2>Introducing Airflow<a class="headerlink" href="#introducing-airflow" title="Permalink to this heading">#</a></h2>
<p>Airflow is a platform that allows users programmatically author, schedule and
monitor workflows. Users organize tasks a DAG and the Airflow scheduler executes
the tasks on workflows while following the specified dependencies.</p>
<p>Taking the following ETL workflow as an example <a class="footnote-reference brackets" href="#id3" id="id1">1</a>,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@dag</span><span class="p">(</span><span class="n">schedule_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">days_ago</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;example&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">tutorial_taskflow_api_etl</span><span class="p">():</span>
    <span class="nd">@task</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">extract</span><span class="p">():</span>
        <span class="n">data_string</span> <span class="o">=</span> <span class="s1">&#39;{&quot;1001&quot;: 301.27, &quot;1002&quot;: 433.21, &quot;1003&quot;: 502.22}&#39;</span>

        <span class="n">order_data_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data_string</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">order_data_dict</span>

    <span class="nd">@task</span><span class="p">(</span><span class="n">multiple_outputs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">order_data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_order_value&quot;</span><span class="p">:</span> <span class="n">total_order_value</span><span class="p">}</span>

    <span class="nd">@task</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">total_order_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total order value is: </span><span class="si">{</span><span class="n">total_order_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">order_data</span> <span class="o">=</span> <span class="n">extract</span><span class="p">()</span>
    <span class="n">order_summary</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
    <span class="n">load</span><span class="p">(</span><span class="n">order_summary</span><span class="p">[</span><span class="s2">&quot;total_order_value&quot;</span><span class="p">])</span>

<span class="n">tutorial_etl_dag</span> <span class="o">=</span> <span class="n">tutorial_taskflow_api_etl</span><span class="p">()</span>
</pre></div>
</div>
<p>It forms the following DAG, including three individual tasks as the nodes, and
edges between nodes that describe the data dependency relations. Airflow scheduler
runs the tasks one after another based the the data dependency.</p>
<img alt="Airflow ETL Workflow" src="../_images/airflow_etl.jpg" />
</div>
<div class="section" id="id2">
<h2>Airflow on Vineyard<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h2>
<div class="section" id="why-airflow-on-vineyard">
<h3>Why Airflow on Vineyard<a class="headerlink" href="#why-airflow-on-vineyard" title="Permalink to this heading">#</a></h3>
<p>Airflows works pretty well on defining and orchestrating the complex workflows.
However, the data flow in the pipeline is still a missing piece. Airflow leverages
the database backend, e.g., SQLite, MySQL and PostgreSQL to store the intermediate
data between tasks. Large-scale data in real world scenarios cannot be fit into
the database, e.g., large tensors, dataframes, and even distributed graphs, and
external storage like HDFS, S3 will be used to store the intermediate data, and
there’s only an identifer in the database.</p>
<p>Using external storage system to share the intermediate data among tasks in big
data analytical pipelines suffers the performance cost of data copy, serialization/
serialization and network data transfer.</p>
<p>Vineyard is designed for sharing intermediate data in-memory efficiently for big
data analytical pipeline and it is a natural fit for workloads on Airflow.</p>
</div>
<div class="section" id="how-vineyard-works-for-airflow">
<h3>How Vineyard Works for Airflow<a class="headerlink" href="#how-vineyard-works-for-airflow" title="Permalink to this heading">#</a></h3>
<p>Airflow allows users to registering an external <strong>XCom</strong> backend and that’s exactly
vineyard is designed for.</p>
<p>Vineyard works as a <em>XCom</em> backend for airflow workers to allow transferring
large-scale data objects between tasks that cannot be fit into the Airflow’s
database backend without involving external storage systems like HDFS. The
Vineyard XCom backend handles object migration as well when the required inputs
is not located on where the task is scheduled to execute.</p>
<p>Vineyard’s XCom backend archives its functionalities by injecting hooks to the
process of saving values to backend and fetching values from backend, as described
follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VineyardXCom</span><span class="p">(</span><span class="n">BaseXCom</span><span class="p">):</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">serialize_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store the value to vineyard server, and serialized the result</span>
<span class="sd">            Object ID to save it into the backend database later.</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deserialize_value</span><span class="p">(</span><span class="n">result</span><span class="p">:</span> <span class="s2">&quot;XCom&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Obtain the Object ID after deserialization, and fetching the</span>
<span class="sd">            underlying value from vineyard.</span>

<span class="sd">            This value is resolved from vineyard objects in a zero-copy</span>
<span class="sd">            fashion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="when-it-comes-to-distributed-deployment">
<h3>When it Comes to Distributed Deployment<a class="headerlink" href="#when-it-comes-to-distributed-deployment" title="Permalink to this heading">#</a></h3>
<p>Airflow supports executing tasks on a set of workers to parallelize the
processing of complex workflows. In a distributed deployment (with the
<code class="code docutils literal notranslate"><span class="pre">CeleryExecutor</span></code>), two tasks that shares intermediate data might
be scheduled to different workers, and a remote data accessing is needed.</p>
<p>Vineyards supports migration for arbitrary objects. In the XCom backend,
when the IPC client meets remote objects, it first trigger a migration
action to move the objects to local to make sure the input data is ready
before executing the tasks.</p>
<p>The migration of objects is transparent to users and relieves the burden
of thinking about of complex data operations and movement then the data
scientists can focus on the computation logic when developing a big data
applications on Airflow.</p>
</div>
</div>
<div class="section" id="running-vineyard-airflow">
<h2>Running Vineyard + Airflow<a class="headerlink" href="#running-vineyard-airflow" title="Permalink to this heading">#</a></h2>
<p>Users can try Airflow provider for Vineyard by the following steps:</p>
<ol class="arabic">
<li><p>Install required packages:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip3 install airflow-provider-vineyard
</pre></div>
</div>
</li>
<li><p>Configure Vineyard locally</p>
<p>The vineyard server can be easier launched locally with the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -m vineyard --socket<span class="o">=</span>/tmp/vineyard.sock
</pre></div>
</div>
<p>See also our documentation about <a class="reference external" href="https://v6d.io/notes/getting-started.html#starting-vineyard-server">launching vineyard</a>.</p>
</li>
<li><p>Configure Airflow to use the vineyard XCom backend by specifying the environment
variable</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">AIRFLOW__CORE__XCOM_BACKEND</span><span class="o">=</span>vineyard.contrib.airflow.xcom.VineyardXCom
</pre></div>
</div>
<p>and configure the location of UNIX-domain IPC socket for vineyard client by</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">AIRFLOW__VINEYARD__IPC_SOCKET</span><span class="o">=</span>/tmp/vineyard.sock
</pre></div>
</div>
<p>or</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">VINEYARD_IPC_SOCKET</span><span class="o">=</span>/tmp/vineyard.sock
</pre></div>
</div>
</li>
<li><p>Launching your airflow scheduler and workers, and run the following DAG as example,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">airflow.decorators</span> <span class="kn">import</span> <span class="n">dag</span><span class="p">,</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">airflow.utils.dates</span> <span class="kn">import</span> <span class="n">days_ago</span>

<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;owner&#39;</span><span class="p">:</span> <span class="s1">&#39;airflow&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="nd">@dag</span><span class="p">(</span><span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span> <span class="n">schedule_interval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">days_ago</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;example&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">taskflow_etl_pandas</span><span class="p">():</span>
    <span class="nd">@task</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">extract</span><span class="p">():</span>
        <span class="n">order_data_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100000</span><span class="p">),</span>
            <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">100000</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">order_data_dict</span>

    <span class="nd">@task</span><span class="p">(</span><span class="n">multiple_outputs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="n">order_data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;total_order_value&quot;</span><span class="p">:</span> <span class="n">order_data_dict</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()}</span>

    <span class="nd">@task</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">total_order_value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total order value is: </span><span class="si">{</span><span class="n">total_order_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">order_data</span> <span class="o">=</span> <span class="n">extract</span><span class="p">()</span>
    <span class="n">order_summary</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">order_data</span><span class="p">)</span>
    <span class="n">load</span><span class="p">(</span><span class="n">order_summary</span><span class="p">[</span><span class="s2">&quot;total_order_value&quot;</span><span class="p">])</span>

<span class="n">taskflow_etl_pandas_dag</span> <span class="o">=</span> <span class="n">taskflow_etl_pandas</span><span class="p">()</span>
</pre></div>
</div>
</li>
</ol>
<p>In above example, task <code class="code docutils literal notranslate"><span class="pre">extract</span></code> and task <code class="code docutils literal notranslate"><span class="pre">transform</span></code> shares a
<code class="code docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> as the intermediate data, which is impossible as
it cannot be pickled and when the data is large, it cannot be fit into the
table in backend databases of Airflow.</p>
<p>The example is adapted from the documentation of Airflow, see also
<a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/tutorial_taskflow_api.html">Tutorial on the Taskflow API</a>.</p>
</div>
<div class="section" id="further-ahead">
<h2>Further Ahead<a class="headerlink" href="#further-ahead" title="Permalink to this heading">#</a></h2>
<p>The Airflow provider for Vineyard is still in every experimental stage and shows
a lot of gains for efficiently and flexibly sharing large-scale intermediate data
using Vineyard for big data analytical workflows in Airflow.</p>
<p>The Airflow community is also striving on better support for modern big data &amp; AI
applications and we believe integrating Vineyard, Airflow, and other cloud-native
infrastructures could deliver a better and more efficient solution for data scientists.</p>
<dl class="footnote brackets">
<dt class="label" id="id3"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>See: <a class="reference external" href="https://airflow.apache.org/docs/apache-airflow/stable/tutorial_taskflow_api.html">https://airflow.apache.org/docs/apache-airflow/stable/tutorial_taskflow_api.html</a></p>
</dd>
</dl>
</div>
</div>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../deployment.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Deployment</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="ml.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Machine Learning with Vineyard</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2019-2022, The Vineyard Authors
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link fa fa-solid fa-github fa-2x" href="https://github.com/v6d-io/v6d" aria-label="GitHub"></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Airflow on Vineyard</a><ul>
<li><a class="reference internal" href="#introducing-airflow">Introducing Airflow</a></li>
<li><a class="reference internal" href="#id2">Airflow on Vineyard</a><ul>
<li><a class="reference internal" href="#why-airflow-on-vineyard">Why Airflow on Vineyard</a></li>
<li><a class="reference internal" href="#how-vineyard-works-for-airflow">How Vineyard Works for Airflow</a></li>
<li><a class="reference internal" href="#when-it-comes-to-distributed-deployment">When it Comes to Distributed Deployment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#running-vineyard-airflow">Running Vineyard + Airflow</a></li>
<li><a class="reference internal" href="#further-ahead">Further Ahead</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>